#!/usr/bin/env ruby

require 'erb'
require 'json'
require 'fileutils'

ARGV << "--help" if ARGV.empty?

ALIASES = {
  "n"  => "new",
  "g"  => "generate",
  "t"  => "test",
  "i"  => "init",
  "ik" => "import_keys",
  "b"  => "build",
  "m"  => "migrate",
  "s"  => "server",
  "c"  => "console",
  "gt" => "geth_test"
}

command = ARGV.shift
command = ALIASES[command] || command

HELP_MESSAGE = <<-EOF
Usage: teth COMMAND [ARGS]
The most common teth commands are:
  new         Create a new Smart Contract application. "teth new my_app" creates a
              new application called MyApp in "./my_app" (short-cut alias: "n")
  generate    Generate new Smart Contract and test file (short-cut alias: "g")
  test        Run tests (short-cut alias: "t")
  init        Init private geth chain (short-cut alias: "i")
  import_keys Import keys to chain (short-cut alias: "ik")
  build       Build contract (short-cut alias: "b")
  migrate     Deploy contract on chain (short-cut alias: "m")
  server      Start chain server (short-cut alias: "s")
  console     Open Chain console (short-cut alias: "c")
  geth_test   Test on chain (short-cut alias: "gt")

All commands can be run with -h (or --help) for more information.
EOF

KEYS_TEMPLATE = {
  "3ae88fe370c39384fc16da2c9e768cf5d2495b48" => "095e53c9c20e23fd01eaad953c01da9e9d3ed9bebcfed8e5b2c2fce94037d963",
  "81063419f13cab5ac090cd8329d8fff9feead4a0" => "5bc505a123a695176a9688ffe22798cfd40424c5b91c818e985574ea8ebda167",
  "9da26fc2e1d6ad9fdd46138906b0104ae68a65d8" => "b6a03207128827eaae0d31d97a7a6243de31f2baf99eabd764e33389ecf436fc"
}

def gem_dir
  spec = Gem::Specification.find_by_name("teth")
  spec.gem_dir
end

def new
  name = ARGV.shift
  if name
    puts "Creating project #{name}..."
    system("mkdir #{name} && cd #{name} && mkdir private_keys && mkdir builds && mkdir temp && mkdir contracts && mkdir tests")
    system("cd #{name} && cd temp && mkdir db && mkdir migrations")
    gemfile = File.read("#{gem_dir}/lib/teth/erbs/Gemfile")

    File.open("#{name}/Gemfile", "w+") {|f| f.write(gemfile) }
    system("cd #{name} && bundle install")

    KEYS_TEMPLATE.each do |k, v|
      File.open("#{name}/private_keys/#{k}.key", "w+") { |f| f.write(v) }
    end

    FileUtils.cp("#{gem_dir}/lib/teth/templates/private_keys/import.sh", "#{name}/private_keys/import.sh")
    FileUtils.chmod 0700, "#{name}/private_keys/import.sh"

    FileUtils.cp("#{gem_dir}/lib/teth/templates/genesis.json", "#{name}/genesis.json")
    FileUtils.cp("#{gem_dir}/lib/teth/templates/rakefile", "#{name}/rakefile")

    FileUtils.cp_r("#{gem_dir}/lib/teth/templates/bin/", "#{name}")
    FileUtils.chmod_R 0700, "#{name}/bin/"
    puts "Done."
  else
    puts "Need project name"
  end
end

def generate
  name = ARGV.shift
  if name
    contract_template = ERB.new File.read("#{gem_dir}/lib/teth/erbs/contract.sol")
    contract = contract_template.result(binding)
    puts "Create #{name.capitalize}.sol contract file..."
    File.open("contracts/#{name.capitalize}.sol", "w+") { |f| f.write(contract) }

    test_template = ERB.new File.read("#{gem_dir}/lib/teth/erbs/contract_test.rb")
    test = test_template.result(binding)
    puts "Create #{name}_test.rb test file..."
    File.open("tests/#{name.capitalize}_test.rb", "w+") {|f| f.write(test) }
    puts "Done."
  else
    puts "Need contract name"
  end
end

def test
  name = ARGV.shift
  if name
    puts "Test #{name.capitalize} contract..."
    system("bundle exec ruby -Ilib:test tests/#{name}_test.rb")
  else
    puts "Test all contracts..."
    system("bundle exec rake")
  end
  puts "Done."
end

def init
  system("./bin/init.sh")
end

def import_keys
  system("./bin/import_keys.sh")
end

def build
  name = ARGV.shift
  system("./bin/build.sh #{name}")
end

def server
  system("./bin/private_blockchain.sh")
end

def migrate
  name = ARGV.shift
  output = `./bin/migrate.sh #{name}`
  puts "output: #{output}"
  contract = ""
  output.split("\n").each do |o|
    if o.match("Contract Instance")
      contract = o.split("Contract Instance : ")[1]
    end
    if o.match("Contract mined!")
      address = o.split("Address: ")[1]
      data = File.read("temp/db/#{contract}.json")
      data = JSON.parse data
      data["address"] = address
      File.open("temp/db/#{contract}.json", "w") do |f|
        f.write(JSON.pretty_generate data)
      end
      File.open("temp/migrations/#{contract}.js", "w") do |f|
        abi = data[contract]["abi"]
        template = ERB.new File.read("#{gem_dir}/lib/teth/erbs/migration")
        migration = template.result(binding)
        f.write(migration)
      end
      File.open("tests/#{contract}_test.js", "w") do |f|
        f.write("loadScript('temp/migrations/#{contract}.js');")
      end
    end
  end
end

def console
  system("./bin/attach.sh")
end

def geth_test
  name = ARGV.shift
  system("./bin/test.sh #{name}")
end

def help
  write_help_message
end

def write_help_message
  puts HELP_MESSAGE
end

def parse_command(command)
  case command
  when "--help", "-h"
    "help"
  else
    command
  end
end

def run_command!(command)
  command = parse_command(command)

  if ALIASES.values.include?(command)
    send(command)
  else
    help
  end
end

run_command!(command)
